<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Frame Editor</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Frame Extraction Progress Modal -->
    <div class="extraction-modal" id="extractionModal" style="display: none;">
        <div class="extraction-modal-content">
            <h3>Extracting Video Frames</h3>
            <div class="extraction-progress">
                <div class="extraction-step" id="extractStep1">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Analyzing video properties...</span>
                    <span class="step-status">pending</span>
                </div>
                <div class="extraction-step" id="extractStep2">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Extracting frames at 30 FPS...</span>
                    <span class="step-status">pending</span>
                </div>
                <div class="extraction-step" id="extractStep3">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Finalizing frame extraction...</span>
                    <span class="step-status">pending</span>
                </div>
            </div>
            <div class="extraction-details" id="extractionDetails">
                <div class="detail-item">
                    <span class="detail-label">Total frames:</span>
                    <span class="detail-value" id="totalFramesCount">Calculating...</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Extracted:</span>
                    <span class="detail-value" id="extractedFramesCount">0</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Speed:</span>
                    <span class="detail-value" id="extractionSpeed">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Progress:</span>
                    <span class="detail-value" id="extractionProgressText">Starting...</span>
                </div>
            </div>
            <div class="extraction-progress-bar">
                <div class="progress-bar-fill" id="extractionProgressBarFill"></div>
            </div>
        </div>
    </div>

    <!-- Export Progress Modal -->
    <div class="export-modal" id="exportModal" style="display: none;">
        <div class="export-modal-content">
            <h3>Exporting Video with Blur Effect</h3>
            <div class="export-progress">
                <div class="export-step" id="step1">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Analyzing video properties...</span>
                    <span class="step-status">pending</span>
                </div>
                <div class="export-step" id="step2">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Processing frames with blur effect...</span>
                    <span class="step-status">pending</span>
                </div>
                <div class="export-step" id="step3">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Copying audio track...</span>
                    <span class="step-status">pending</span>
                </div>
                <div class="export-step" id="step4">
                    <span class="step-icon">‚è≥</span>
                    <span class="step-text">Encoding final video...</span>
                    <span class="step-status">pending</span>
                </div>
            </div>
            <div class="export-details" id="exportDetails">
                <div class="detail-item">
                    <span class="detail-label">Frames with rectangles:</span>
                    <span class="detail-value" id="framesCount">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Total rectangles:</span>
                    <span class="detail-value" id="rectanglesCount">-</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Audio status:</span>
                    <span class="detail-value" id="audioStatus">Checking...</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Progress:</span>
                    <span class="detail-value" id="progressText">Starting...</span>
                </div>
            </div>
            <div class="export-progress-bar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <button class="cancel-export" id="cancelExport" onclick="cancelExport()">Cancel</button>
        </div>
    </div>

    <div class="container">
        <div class="video-selector">
            <label for="videoSelect">Select Video:</label>
            <select id="videoSelect">
                <option value="">Choose a video...</option>
            </select>
            <button onclick="loadVideo()" class="load-video-btn">‚ñ∂Ô∏è Load Video</button>
            <button onclick="cleanupFrames()" class="cleanup-btn" title="Delete all extracted frame files to free disk space">üóëÔ∏è Cleanup Frames</button>
        </div>

        <div class="status" id="status"></div>

        <div class="current-frame" id="currentFrame" style="display: none;">

            <div class="frame-editor-layout">
                <div class="frame-and-info">
                    <div class="frame-display" id="frameDisplay">
                        <img class="frame-image" id="frameImage" src="" alt="Current frame" draggable="false">
                        <!-- Frame Size Info - Top Right of Frame -->
                        <div class="frame-size-overlay">
                            <span id="frameSizeInfo"></span>
                        </div>
                    </div>
                    
                    <!-- Timeline Scrubber -->
                    <div class="timeline-scrubber" id="timelineScrubber">
                        <div class="timeline-track" id="timelineTrack">
                            <div class="timeline-progress" id="timelineProgress"></div>
                            <div class="timeline-handle" id="timelineHandle"></div>
                            <div class="timeline-keyframes" id="timelineKeyframes"></div>
                        </div>
                    </div>
                    
                    <!-- Frame Number Info Section -->
                    <div class="frame-info-section">
                        <div class="frame-info-display">
                            <span id="frameInfo" style="font-weight: bold;"></span>
                        </div>
                    </div>
                    
                    <!-- Navigation Controls -->
                    <div class="frame-navigation">
                        <button onclick="navigateToPreviousChange()">‚Üê Previous Keyframe</button>
                        <button onclick="navigateToNextChange()">Next Keyframe ‚Üí</button>
                    </div>
                </div>
                
                <div class="property-box" id="propertyBox">
                    <!-- Rectangle Management Section -->
                    <div class="rectangle-management-section">
                        <h3>Rectangle Management</h3>
                        <div class="rectangle-controls">
                            <button onclick="clearRectangles()" class="rect-btn clear-btn">Clear All Rectangles</button>
                            <button onclick="loadExistingRectangles()" class="rect-btn load-btn">Load Rectangles</button>
                            <button onclick="saveRectangles()" class="rect-btn save-btn">Save Rectangle Data</button>
                        </div>
                    </div>
                    
                    <h3>Rectangle Properties</h3>
                    <div class="property-table-container">
                        <table class="property-table">
                            <thead>
                                <tr>
                                    <th>Property</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="propertyTableBody">
                                <tr class="no-selection">
                                    <td colspan="2">No rectangle selected</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Export Section -->
                    <div class="export-section">
                        <h3>Export Settings</h3>
                        
                        <div class="export-controls">
                            <div class="export-setting">
                                <label for="codecSelect">Video Codec:</label>
                                <select id="codecSelect">
                                    <option value="libx264">libx264 (Software)</option>
                                    <option value="h264_nvenc" selected>h264_nvenc (NVIDIA GPU)</option>
                                </select>
                            </div>
                            
                            <div class="export-setting">
                                <label for="blurAmount">Blur Amount:</label>
                                <select id="blurAmount">
                                    <option value="5">Light (5px)</option>
                                    <option value="10">Medium (10px)</option>
                                    <option value="15" selected>Heavy (15px)</option>
                                    <option value="20">Very Heavy (20px)</option>
                                    <option value="30">Extreme (30px)</option>
                                </select>
                            </div>
                            
                            <div class="export-buttons">
                                <button onclick="previewBlurred()" class="preview-btn">Preview Blur (200 frames)</button>
                                <button onclick="exportBlurred()" class="export-btn">Export Video with Blur</button>
                            </div>
                            
                            <div id="previewLinkContainer" class="preview-link-container" style="display: none;">
                                <div class="preview-link-header">
                                    <span class="preview-icon">üé¨</span>
                                    <strong>Preview Ready!</strong>
                                </div>
                                <a id="previewLink" href="#" target="_blank" class="preview-link">
                                    <span class="link-icon">‚ñ∂Ô∏è</span>
                                    <span class="link-text">View Preview Video</span>
                                    <span class="link-hint">(opens in new tab)</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


        </div>

        <div class="timeline" id="timeline" style="display: none;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; margin-right: 20px;">Timeline</h3>
                <div style="display: flex; align-items: center;">
                    <label for="thumbnailInterval" style="margin-right: 8px; font-size: 14px;">Thumbnail every:</label>
                    <select id="thumbnailInterval" onchange="updateTimeline()"
                        style="padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        <option value="5">5 seconds</option>
                        <option value="10">10 seconds</option>
                        <option value="20">20 seconds</option>
                        <option value="30" selected>30 seconds</option>
                    </select>
                </div>
            </div>
            <div class="timeline-frames" id="timelineFrames">
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>

</html>